# Пакет сетевых модулей

Включает модули: 
* server-tcp
* server-udp
* client-tcp
* io-queue - 
* statistics - сбор статистики 

Документация [doxygen](https://mambaru.github.io/wfc_core/index.html).
Репозитарий на [github.com](https://github.com/mambaru/wfc_core).

## server-tcp

Минимальная конфигурация:
```
{
  "server-tcp": [
    {
      "name": "server-tcp1",
      "port": "12345"
    }
  ]
}
```
В этой конфигурации сервер открывает порт на localhost, акцептит подключения, но сбрасывает их при попытке отправить ему данные. Для полноценной работы необходимо 
указать цель, которая будет обрабатывать входящий поток данных. Это как правило jsonrpc-сервис прикладного модуля или вспомогательные jsonrpc-модули. В следующем примере 
входящие сообщения отправляются в сыром виде hash-объекту из [демо](https://github.com/mambaru/demod) примера:
```
{
  "server-tcp": [
    {
      "name": "server-tcp1",
      "target": "hash1",
      "addr": "0.0.0.0",
      "port": "12345"
    }
  ],
  "hash": [
    {
      "name": "hash1"
    }
  ]
}
```
*server-tcp* поддерживает динамическую реконфигурацию, но при реконфигурировании все текущие соединения сбрасываются. В suspend-режиме работает как эхо-сервис. 
Если включена динамическая реконфигурация и изменен только флаг suspend, то изменения вступают в силу только для новых подключений, а текущие продолжают работать. 

По умолчанию архитектура однопоточная (thrеads=0, работает в основном потоке приложения), при увеличении числа потоков работает в режиме акцептор-на-поток, соединение 
работает в том же потоке, где и получило акцепт. При высоких нагрузках рекомендуется выделить хотя-бы один поток (thrеads=1) в этом режиме сервер так же однопоточный, 
но работает в отдельном потоке, и не захламляет заданиями основную очередь приложения, где крутятся таймеры и пр. Если используются очереди, то выделять большое количество 
потоков для сервера не имеет смысла, лучше увеличить число потоков для разбора очередей (см. [workflow](https://github.com/mambaru/wfc_core)). Если время ответа 
прикладной логики стабильно невысокое, то использование очередей может не дать профита, а только увеличит нагрузку на CPU.

Конфигурация:
```
{
  "server-tcp": [
    {
      "name": "server-tcp1",
      /* В отключенном режиме сервер не создается*/
      "enabled": true,
      /* В режиме suspend работает как эхо-сервер */
      "suspend": false,
      /* Приоритет запуска. Укажите минимальный (максимальное значение), если порты необходимо открыть после запуска остальных объектов */
      "startup_priority": 0,
      /* Приоритет остановки. Укажите максимальный (минимальное значение), если порты необходимо закрыть в первую очередь */
      "shutdown_priority": 0,
      /* Номера ядер CPU для потоков сервера, например [1,2,3] */
      "cpu": [],
      /* Цель - куда передать полученные данные */
      "target": "",
      /* По умолчанию использовать разделитель `\r\n` для сообщений. Если false, то настраивается в connection */
      "rn": true,
      /* Не закрывать соединение после отправки ответа */
      "keep_alive": true,
      /* Число потоков. 0-в основном потоке приложения, 1-в отдельном потоке, N-акцептор на поток */
      "threads": 0,
      /* Адрес */
      "addr": "",
      /* Порт */
      "port": "",
      /* Системная очередь новых соединений */
      "backlog": 1024,
      /* Максимальное количество одновременных подключения. 0 - без ограничения */
      "max_connections": 0,
      /* Настройки соединения */
      "connection": {
        /* В режиме direct_mode=true отключается регистрация нового соединения в целевом объекте.
           Работает быстрее, но не все целевые объекты поддерживают такой режим, например очередь 
           c connection_tracking=true () */
        "direct_mode": false,
        /* Размер буфера приема сообщений сокета (SOL_SOCKET/SO_RCVBUF). 0 - не изменять */
        "receive_buffer_size": 0,
        /* Размер буфера отправки сокета (SOL_SOCKET/SO_SNDBUF). 0 - не изменять */ */
        "send_buffer_size": 0,
        "reader": {
          /* Разделитель входящих сообщений. Если задан, то поле rn-игнорируется и используется это значение.
             Если не задан (="") и если rn=true, то это эквивалентно sep="\r\n".
             Если не задан (="") и если rn=false, то без разделения, для двоичных данных. */
          "sep": "",
          /* Рекомендуемый размер приемного буфера (в бинарном режиме )*/
          "bufsize": 4096,
          "maxbuf": 8192,
          "minbuf": 0,
          "maxsize": 0,
          "trimsep": true
        },
        "writer": {
          "sep": "",
          "bufsize": 8192,
          "maxbuf": 8192,
          "minbuf": 0,
          "maxsize": 0,
          "first_as_is": true
        }
      }
    }
  ]
}```

## server-udp

## client-tcp1

## io-queue

## Настройка для высоких нагрузок

## Режим проксирования
